# Updater Managed Cleanup

Апдейтер имеет право удалять только свои артефакты. Все управляемые файлы должны трекаться в конфиге по `projectPath`.

## Правильно

- Обновлять commands/rules/tools строго по манифесту
- Хранить список управляемых файлов с SHA-256 хешами (`ManagedFileEntry { path, hash }`)
- Перед перезаписью файла — сравнивать хеш на диске с эталонным
- Если файл изменён пользователем — бэкапить в `{projectPath}/.user-overrides/` перед перезаписью
- Обновлять/удалять hooks только для управляемых команд (smart merge)
- Удалять только устаревшие managed-файлы

## Неправильно

- Удалять пользовательские файлы или правила
- Перезаписывать файлы без проверки user-модификаций
- Применять backup-стратегию к hooks-файлам (hooks.json, .claude/settings.json — только smart merge)
- Оставлять устаревшие hooks после обновления

## User Modifications Protection

Стратегия: **Content Hash + Backup + Overwrite**

1. При записи managed-файла апдейтер сохраняет SHA-256 хеш содержимого
2. При следующем обновлении — сравнивает хеш файла на диске с сохранённым
3. Если хеши не совпадают (файл изменён пользователем):
   - Копирует текущий файл в `.user-overrides/{relativePath}`
   - Перезаписывает upstream-версией
   - Записывает в `~/.dev-pomogator/last-update-report.md`
4. Hooks-файлы обновляются через smart merge (read-modify-write), пользовательские хуки не затрагиваются

## Чеклист

- [ ] Managed-список обновлён после апдейта (с хешами)
- [ ] Удалены только устаревшие managed-файлы
- [ ] User-модификации забэкаплены в `.user-overrides/` перед перезаписью
- [ ] Hooks синхронизированы без дубликатов (smart merge)
- [ ] Пользовательские хуки сохранены при обновлении
- [ ] `.user-overrides/` добавлен в `.gitignore`
