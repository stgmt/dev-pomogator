# GUI Testing Container based on linuxserver/webtop
# Provides Ubuntu XFCE desktop accessible via browser
# With Cursor IDE and Claude Code CLI pre-installed

FROM linuxserver/webtop:ubuntu-xfce

# Install Node.js 20, git, and other tools
# linuxserver images run init as root, so these commands work
RUN apt-get update && apt-get install -y \
    curl \
    git \
    wget \
    gnupg \
    ca-certificates \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install PowerShell Core
RUN wget -q https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb \
    && dpkg -i packages-microsoft-prod.deb \
    && rm packages-microsoft-prod.deb \
    && apt-get update \
    && apt-get install -y powershell \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code

# Download and extract Cursor AppImage (FUSE not available in container)
RUN mkdir -p /opt/cursor && \
    CURSOR_URL=$(curl -sL 'https://www.cursor.com/api/download?platform=linux-x64&releaseTrack=stable' | grep -o '"downloadUrl":"[^"]*"' | cut -d'"' -f4) && \
    curl -L "$CURSOR_URL" -o /opt/cursor/cursor.AppImage && \
    chmod +x /opt/cursor/cursor.AppImage && \
    cd /opt/cursor && ./cursor.AppImage --appimage-extract && \
    rm cursor.AppImage

# Create custom-cont-init.d script to create shortcuts at runtime
# This runs as root during container initialization
RUN mkdir -p /custom-cont-init.d && \
    echo '#!/bin/bash' > /custom-cont-init.d/01-setup-desktop && \
    echo 'echo "Setting up desktop shortcuts..."' >> /custom-cont-init.d/01-setup-desktop && \
    echo '' >> /custom-cont-init.d/01-setup-desktop && \
    echo '# Create desktop shortcuts' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'mkdir -p /config/Desktop' >> /custom-cont-init.d/01-setup-desktop && \
    echo '' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'cat > /config/Desktop/cursor.desktop << EOF' >> /custom-cont-init.d/01-setup-desktop && \
    echo '[Desktop Entry]' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Version=1.0' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Type=Application' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Name=Cursor IDE' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Comment=Cursor AI IDE' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Exec=/opt/cursor/squashfs-root/AppRun --no-sandbox' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Icon=code' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Terminal=false' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Categories=Development;IDE;' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'EOF' >> /custom-cont-init.d/01-setup-desktop && \
    echo '' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'cat > /config/Desktop/claude-code.desktop << EOF' >> /custom-cont-init.d/01-setup-desktop && \
    echo '[Desktop Entry]' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Version=1.0' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Type=Application' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Name=Claude Code' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Comment=Claude Code CLI' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Exec=xfce4-terminal -e "claude"' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Icon=utilities-terminal' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Terminal=true' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Categories=Development;' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'EOF' >> /custom-cont-init.d/01-setup-desktop && \
    echo '' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'cat > /config/Desktop/terminal.desktop << EOF' >> /custom-cont-init.d/01-setup-desktop && \
    echo '[Desktop Entry]' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Version=1.0' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Type=Application' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Name=Terminal' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Exec=xfce4-terminal' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Icon=utilities-terminal' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Terminal=false' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'Categories=System;' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'EOF' >> /custom-cont-init.d/01-setup-desktop && \
    echo '' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'chmod +x /config/Desktop/*.desktop' >> /custom-cont-init.d/01-setup-desktop && \
    echo 'chown -R abc:abc /config/Desktop' >> /custom-cont-init.d/01-setup-desktop && \
    chmod +x /custom-cont-init.d/01-setup-desktop

# Set working directory
WORKDIR /app

# Expose ports
# 3000 - HTTP
# 3001 - HTTPS  
EXPOSE 3000 3001
