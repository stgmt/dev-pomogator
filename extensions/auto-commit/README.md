# auto-commit

Automatic git commits with LLM-generated messages on agent stop.

## Features

- **Smart Triggers**: Commits on agent stop (not every prompt) - less spam, better timing
- **Session Context**: Reads Cursor transcripts to understand what you worked on
- **Gitmoji Support**: Commit messages with semantic emojis (‚ú® feat, üêõ fix, etc.) in full format
- **Jira Integration**: Extracts Jira key from branch name; optional Smart Commit mode
- **Configurable**: Global and per-project configuration
- **Token-Safe**: Redacts secrets from context before sending to LLM

## How it Works

1. Triggers on agent stop event (Cursor: `stop`, Claude Code: `Stop`)
2. Checks if commit interval has passed (default: 15 minutes)
3. Reads session transcript for context (FAST PATH) or SQLite (FALLBACK)
4. Gets git diff and changed files
5. Extracts Jira key from branch name (if configured)
6. Generates commit message or Smart Commit summary via LLM API
7. Commits changes with formatted message

## Configuration

### Environment Variables

```bash
# Required: Your API key for LLM service
AUTO_COMMIT_API_KEY=sk-xxx

# Optional: Custom LLM endpoint (default: aipomogator.ru)
AUTO_COMMIT_LLM_URL=https://aipomogator.ru/go/v1

# Optional: Model to use
AUTO_COMMIT_LLM_MODEL=openrouter/deepseek/deepseek-v3.2

# Optional: Disable auto-commit
AUTO_COMMIT_DISABLED=1
```

### Config Files

Create `~/.cursor/auto-commit.json` for global settings or `.cursor/auto-commit.json` for project-specific settings:

```json
{
  "enabled": true,
  "intervalMinutes": 15,
  "jiraKeyPattern": "PROJ-\\d+",
  "jiraBaseUrl": "https://jira.example.com/browse/",
  "maxDiffTokens": 4000,
  "maxDialogs": 3,
  "maxMessages": 12,
  "smartCommit": {
    "enabled": false,
    "command": "comment"
  },
  "llm": {
    "baseUrl": "https://aipomogator.ru/go/v1",
    "model": "openrouter/deepseek/deepseek-v3.2",
    "apiKey": "sk-xxx"
  }
}
```

### Config Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `enabled` | boolean | `true` | Enable/disable auto-commit |
| `intervalMinutes` | number | `15` | Minimum minutes between commits |
| `jiraKeyPattern` | string | `[A-Z]+-\\d+` | Regex to extract Jira key from branch |
| `jiraBaseUrl` | string | `""` | Base URL for Jira links |
| `maxDiffTokens` | number | `4000` | Max tokens for git diff |
| `maxDialogs` | number | `3` | Max dialogs to include in context |
| `maxMessages` | number | `12` | Max messages per dialog |
| `smartCommit.enabled` | boolean | `false` | Enable Smart Commit one-line format |
| `smartCommit.command` | string | `"comment"` | Smart Commit command (e.g. `comment`) |
| `llm.baseUrl` | string | env/default | LLM API base URL |
| `llm.model` | string | env/default | LLM model name |
| `llm.apiKey` | string | env | LLM API key |

## Commit Message Format

### Default (full format)
```
‚ú® feat(scope): short description

üé´ [PROJ-123](https://jira.example.com/browse/PROJ-123)

## üìù Summary
Description of what was done and why.

## üìÅ New Files
| File | Description |
|------|-------------|
| `src/main.ts` | Main entry point |

## ‚úèÔ∏è Modified Files
| File | Description |
|------|-------------|
| `package.json` | Added dependency |

---
ü§ñ Auto-generated by Cursor Agent

üìä Tokens: 500 (prompt: 400, completion: 100)
```

### Smart Commit (optional)
```
PROJ-123 #comment short summary of changes
```
Notes:
- Requires Jira key in branch name (matches `jiraKeyPattern`)
- Single line only; if Smart Commit is enabled and no Jira key is found, auto-commit fails fast

## Requirements

- Node.js 18+
- Git
- `npx` and `tsx` available in PATH
- LLM API key (set via env or config)

## Logs

Logs are written to stderr with format:
```
[2024-01-15T10:30:00.000Z] [AUTO-COMMIT] [INFO] Processing stop hook...
```

## Troubleshooting

### No commits happening

1. Check if `AUTO_COMMIT_API_KEY` is set
2. Check if interval has passed (default 15 min)
3. Check if there are uncommitted changes
4. Check logs for errors

### Missing Jira link

1. Set `jiraBaseUrl` in config
2. Ensure branch name contains Jira key matching `jiraKeyPattern`

### Slow context loading

1. Ensure `transcript_path` is provided by Cursor (FAST PATH)
2. SQLite fallback is slow (~33 sec) - this is expected

## Files

```
extensions/auto-commit/
‚îú‚îÄ‚îÄ extension.json           # Hook configuration
‚îú‚îÄ‚îÄ README.md                # This file
‚îî‚îÄ‚îÄ tools/auto-commit/
    ‚îú‚îÄ‚îÄ auto_commit_core.ts      # Config, state, git operations
    ‚îú‚îÄ‚îÄ auto_commit_llm.ts       # LLM API client
    ‚îú‚îÄ‚îÄ auto_commit_transcript.ts # Transcript parsing
    ‚îú‚îÄ‚îÄ auto_commit_stop.ts      # Main entry point
    ‚îî‚îÄ‚îÄ auto_commit_prompt_guide.md # Prompt guidelines
```
